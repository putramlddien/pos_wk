{% extends "base.html" %} {% block content %}
<div class="container mx-auto p-5">
  <div
    class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8"
  >
    <h2 class="text-2xl font-bold mb-6 text-center">Checkout Order</h2>
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Order Details</h3>
      <div class="grid grid-cols-1 gap-2">
        {% for item in order.order_details.all %}
        <div class="flex justify-between items-center border-b py-2">
          <div>
            <span class="font-semibold">{{ item.product.name }}</span>
            <span class="text-xs text-gray-500">x{{ item.quantity }}</span>
          </div>
          <div class="text-right font-bold text-blue-600">
            Rp{{ item.price|floatformat:0 }}
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="flex justify-between items-center mt-4 border-t pt-4">
        <span class="font-semibold text-gray-700 dark:text-white">Total:</span>
        <span class="font-bold text-xl text-green-600"
          >Rp{{ order.total_price|floatformat:0 }}</span
        >
      </div>
    </div>
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Pilih Metode Pembayaran</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          id="payCashBtn"
          class="payment-method-card border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center hover:border-green-500 focus:border-green-600 transition"
        >
          <span class="text-2xl mb-2">ðŸ’µ</span>
          <span class="font-bold">Cash</span>
        </button>
        <button
          id="payMidtransBtn"
          class="payment-method-card border-2 border-gray-200 rounded-lg p-4 flex flex-col items-center hover:border-blue-500 focus:border-blue-600 transition"
        >
          <span class="text-2xl mb-2">ðŸ’³</span>
          <span class="font-bold">Midtrans (QRIS, e-Wallet, VA)</span>
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal Konfirmasi Pembayaran Cash -->
<div
  id="cashConfirmModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md"
  >
    <h3 class="text-lg font-bold mb-4">Konfirmasi Pembayaran Cash</h3>
    <p class="mb-4">Pastikan pembayaran sudah diterima. Lanjutkan?</p>
    <div class="flex justify-end gap-2">
      <button
        onclick="closeCashModal()"
        class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300"
      >
        Batal
      </button>
      <button
        onclick="payCash()"
        class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
      >
        Konfirmasi
      </button>
    </div>
  </div>
</div>
<!-- Modal Feedback -->
<div
  id="feedbackModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md text-center"
  >
    <h3 id="feedbackTitle" class="text-lg font-bold mb-4"></h3>
    <p id="feedbackMsg" class="mb-4"></p>
    <button
      onclick="closeFeedbackModal()"
      class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
    >
      OK
    </button>
  </div>
</div>
<script
  src="https://app.sandbox.midtrans.com/snap/snap.js"
  data-client-key="SB-Mid-client-WqozVbKxVoU3v-9L"
></script>
<script>
  const orderId = {{ order.id }};
  document.getElementById('payCashBtn').onclick = function() {
    document.getElementById('cashConfirmModal').classList.remove('hidden');
  };
  function closeCashModal() {
    document.getElementById('cashConfirmModal').classList.add('hidden');
  }
  function payCash() {
    fetch(`/checkout/${orderId}/pay-cash/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
    })
    .then(res => res.json())
    .then(data => {
      closeCashModal();
      showFeedback(data.success ? 'Pembayaran Berhasil' : 'Pembayaran Gagal', data.message || (data.success ? 'Order telah dibayar.' : 'Terjadi kesalahan.'));
      if (data.success) setTimeout(() => window.location.href = '/order-list/', 1500);
    })
    .catch(() => {
      closeCashModal();
      showFeedback('Error', 'Gagal terhubung ke server.');
    });
  }
  document.getElementById('payMidtransBtn').onclick = function() {
    fetch(`/checkout/${orderId}/midtrans-token/`)
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          window.snap.pay(data.token, {
            onSuccess: function(result) {
              showFeedback('Pembayaran Berhasil', 'Transaksi berhasil!');
              setTimeout(() => window.location.href = '/order-list/', 1500);
            },
            onPending: function(result) {
              showFeedback('Menunggu Pembayaran', 'Silakan selesaikan pembayaran di aplikasi Anda.');
            },
            onError: function(result) {
              showFeedback('Pembayaran Gagal', 'Terjadi kesalahan pada pembayaran.');
            },
            onClose: function() {
              // Modal ditutup tanpa pembayaran
            }
          });
        } else {
          showFeedback('Error', 'Gagal mendapatkan token pembayaran.');
        }
      })
      .catch(() => {
        showFeedback('Error', 'Gagal terhubung ke server.');
      });
  };
  function showFeedback(title, msg) {
    document.getElementById('feedbackTitle').innerText = title;
    document.getElementById('feedbackMsg').innerText = msg;
    document.getElementById('feedbackModal').classList.remove('hidden');
  }
  function closeFeedbackModal() {
    document.getElementById('feedbackModal').classList.add('hidden');
  }
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
