{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-5">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- Kiri: Product & Category -->
    <div class="md:col-span-2">
      <h2 class="text-2xl font-bold mb-5">Make Order</h2>
      <!-- Filter & Search -->
      <form
        id="filterForm"
        method="get"
        class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-end"
        onsubmit="return false;"
      >
        <div>
          <label class="block text-xs mb-1">Category</label>
          <select
            name="category"
            id="categorySelect"
            class="border rounded px-2 py-1"
          >
            <option
              value="all"
              {% if selected_category == 'all' %}selected{% endif %}
            >
              All
            </option>
            {% for cat in categories %}
            <option
              value="{{ cat }}"
              {% if selected_category == cat %}selected{% endif %}
            >
              {{ cat }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs mb-1">Search</label>
          <input
            type="text"
            name="search"
            id="searchInput"
            value="{{ search_query }}"
            placeholder="Product name..."
            class="border rounded px-2 py-1"
            autocomplete="off"
          />
        </div>
      </form>
      <script>
        // Realtime filter for category
        document.getElementById('categorySelect').addEventListener('change', function() {
          const cat = this.value;
          const search = document.getElementById('searchInput').value;
          let url = '?';
          if (cat && cat !== 'all') url += 'category=' + encodeURIComponent(cat) + '&';
          if (search) url += 'search=' + encodeURIComponent(search) + '&';
          window.location = url;
        });
        // Realtime search (debounced)
        let searchTimeout = null;
        document.getElementById('searchInput').addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const cat = document.getElementById('categorySelect').value;
            const search = this.value;
            let url = '?';
            if (cat && cat !== 'all') url += 'category=' + encodeURIComponent(cat) + '&';
            if (search) url += 'search=' + encodeURIComponent(search) + '&';
            window.location = url;
          }, 400);
        });
      </script>
      <!-- Product Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    {% for product in products %}
    <div
      class="flex flex-col items-center justify-center w-full max-w-sm mx-auto"
    >
      <div
        class="w-full h-40 bg-gray-300 bg-center bg-cover rounded-lg shadow-md"
        style="background-image: url('{{ product.image.url }}')"
      ></div>

      <div
        class="w-80 -mt-10 overflow-hidden bg-white rounded-lg shadow-lg md:w-40 dark:bg-gray-800"
      >
        <h5
          class="text-sm mt-2 mb-2 font-medium tracking-wide text-center text-black uppercase dark:text-white"
        >
          {{ product.name }} ({{ product.stock }})
        </h5>

        <div
          class="flex items-center justify-between px-3 py-2 bg-gray-200 dark:bg-gray-700"
        >
          <span class="font-bold text-gray-800 dark:text-gray-200"
            >Rp {{ product.price|floatformat:0 }}</span
          >
          <button
            onclick="addToCart('{{ product.id }}', '{{ product.name|escapejs }}', '{{ product.price|floatformat:0 }}', '{{ product.image.url }}')"
            class="px-2 py-1 text-xs font-semibold text-white uppercase transition-colors duration-300 transform bg-gray-800 rounded hover:bg-gray-700 dark:hover:bg-gray-600 focus:bg-gray-700 dark:focus:bg-gray-600 focus:outline-none"
          >
            Add
          </button>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-3 text-center text-gray-500 dark:text-gray-400">
      No products found.
    </div>
    {% endfor %}
  </div>
      <!-- Pagination -->
      {% if products.paginator.num_pages > 1 %}
      <div class="flex justify-center mt-6">
        <nav
          class="inline-flex rounded-md shadow-sm"
          aria-label="Pagination"
        >
          {% if products.has_previous %}
          <a
            href="?{% if selected_category %}category={{ selected_category }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ products.previous_page_number }}"
            class="px-4 py-2 mx-1 text-gray-700 bg-white rounded-md dark:bg-gray-800 dark:text-gray-200 hover:bg-blue-600 dark:hover:bg-blue-500 hover:text-white dark:hover:text-gray-200"
            >&laquo;</a
          >
          {% endif %}
          {% for num in page_range %}
          {% if products.number == num %}
          <span class="px-4 py-2 mx-1 text-white bg-blue-600 rounded-md">
            {{ num }}
          </span>
          {% else %}
          <a
            href="?{% if selected_category %}category={{ selected_category }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ num }}"
            class="px-4 py-2 mx-1 text-gray-700 bg-white rounded-md dark:bg-gray-800 dark:text-gray-200 hover:bg-blue-600 dark:hover:bg-blue-500 hover:text-white dark:hover:text-gray-200"
            >{{ num }}</a
          >
          {% endif %}
          {% endfor %}
          {% if products.has_next %}
          <a
            href="?{% if selected_category %}category={{ selected_category }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ products.next_page_number }}"
            class="px-4 py-2 mx-1 text-gray-700 bg-white rounded-md dark:bg-gray-800 dark:text-gray-200 hover:bg-blue-600 dark:hover:bg-blue-500 hover:text-white dark:hover:text-gray-200"
            >&raquo;</a
          >
          {% endif %}
        </nav>
      </div>
      {% endif %}
    </div>
    <!-- Kanan: Cart -->
    <div
      class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 sticky top-18 h-fit"
    >
      <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Cart</h2>
      <div class="mb-4">
        <input
          id="customerName"
          type="text"
          class="w-full px-3 py-2 mb-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white mb-5"
          placeholder="Customer Name"
        />
        <select
          id="tableSelect"
          class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"
        >
          <option value="">Pilih Nomor Meja</option>
          {% for table in tables %}
          <option value="{{ table.id }}" class="text-black">Meja {{ table.table_number }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="cartItems" class="space-y-4 mb-4">
        <!-- Cart items will be rendered here by JS -->
      </div>
      <div class="flex justify-between items-center border-t pt-4">
        <span class="font-semibold text-gray-700 dark:text-white">Total:</span>
        <span id="cartTotal" class="font-bold text-lg text-blue-600">Rp0</span>
      </div>
      <button
        class="w-full mt-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition"
        onclick="openConfirmModal()"
      >
        Checkout
      </button>
    </div>
  </div>
</div>

<!-- Modal Konfirmasi -->
<div
  id="confirmModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md"
  >
    <h3 class="text-lg font-bold mb-4">Konfirmasi Order</h3>
    <p class="mb-4">Apakah Anda yakin ingin memproses pesanan ini?</p>
    <div class="flex justify-end gap-2">
      <button
        onclick="closeConfirmModal()"
        class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300"
      >
        Batal
      </button>
      <button
        onclick="checkoutCart()"
        class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
      >
        Konfirmasi
      </button>
    </div>
  </div>
</div>

<script>
  // Category filter
  function filterCategory(category) {
    document.querySelectorAll(".order-card").forEach((card) => {
      if (
        category === "all" ||
        card.getAttribute("data-category") === category
      ) {
        card.style.display = "";
      } else {
        card.style.display = "none";
      }
    });
  }

  // Cart logic
  let cart = [];
  function addToCart(id, name, price, image) {
    id = parseInt(id);
    price = parseInt(price);
    const idx = cart.findIndex((item) => item.id === id);
    if (idx > -1) {
      cart[idx].qty += 1;
    } else {
      cart.push({ id, name, price, image, qty: 1 });
    }
    renderCart();
  }
  function removeFromCart(id) {
    cart = cart.filter((item) => item.id !== id);
    renderCart();
  }
  function updateQty(id, qty) {
    const item = cart.find((i) => i.id === id);
    if (item) {
      item.qty = Math.max(1, qty);
      renderCart();
    }
  }
  function incrementQty(id) {
    const item = cart.find((i) => i.id === id);
    if (item) {
      item.qty += 1;
      renderCart();
    }
  }
  function decrementQty(id) {
    const item = cart.find((i) => i.id === id);
    if (item && item.qty > 1) {
      item.qty -= 1;
      renderCart();
    }
  }
  function renderCart() {
    const cartItems = document.getElementById("cartItems");
    cartItems.innerHTML = "";
    let total = 0;
    cart.forEach((item) => {
      total += item.price * item.qty;
      cartItems.innerHTML += `
      <div class="flex items-center gap-3 border-b pb-2">
        <img src="${item.image}" class="w-12 h-12 object-cover rounded" alt="${
        item.name
      }">
        <div class="flex-1">
          <div class="font-semibold text-gray-800 dark:text-white">${
            item.name
          }</div>
          <div class="text-xs text-gray-500">Rp${item.price.toLocaleString()}</div>
        </div>
        <div class="flex items-center gap-1">
          <button onclick="decrementQty(${
            item.id
          })" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">-</button>
          <input type="number" min="1" value="${
            item.qty
          }" class="w-12 px-2 py-1 border rounded text-center dark:text-white" onchange="updateQty(${
        item.id
      }, this.value)">
          <button onclick="incrementQty(${
            item.id
          })" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">+</button>
        </div>
        <button onclick="removeFromCart(${
          item.id
        })" class="text-red-500 hover:text-red-700 ml-2">&times;</button>
      </div>
    `;
    });
    document.getElementById(
      "cartTotal"
    ).innerText = `Rp${total.toLocaleString()}`;
  }
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  function openConfirmModal() {
    document.getElementById("confirmModal").classList.remove("hidden");
  }
  function closeConfirmModal() {
    document.getElementById("confirmModal").classList.add("hidden");
  }
  function checkoutCart() {
    const customerName = document.getElementById("customerName").value;
    const tableId = document.getElementById("tableSelect").value;
    if (cart.length === 0) {
      alert("Cart is empty!");
      return;
    }
    fetch("{% url 'create_order' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        cart,
        customer_name: customerName,
        table_id: tableId,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        closeConfirmModal();
        if (data.success && data.redirect_url) {
          cart = [];
          renderCart();
          window.location.href = data.redirect_url;
        } else {
          alert("Gagal membuat order: " + (data.error || "Unknown error"));
        }
      })
      .catch(() => {
        closeConfirmModal();
        alert("Gagal terhubung ke server.");
      });
  }
</script>
{% endblock %}
