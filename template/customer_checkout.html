{% extends "base_customer.html" %} {% block content %}
<div class="container mx-auto max-w-2xl p-6 mt-8">
  <h2 class="text-2xl font-bold mb-4 text-center">Checkout Pesanan Anda</h2>
  <form id="customerCheckoutForm">
    <div id="checkoutCartItems" class="mb-6"></div>
    <div class="mb-4">
      <label class="block mb-1 font-semibold">Pilih Meja</label>
      <select
        id="mejaSelect"
        name="meja_number"
        class="w-full border rounded px-3 py-2 mb-2"
      >
        <option value="">-- Pilih Meja --</option>
        {% for table in tables %}
        <option value="{{ table.table_number }}">
          Meja {{ table.table_number }}
        </option>
        {% endfor %}
        <option value="takeaway">Takeaway</option>
      </select>
    </div>
    <div
      class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
    >
      <div class="flex gap-2 items-center">
        <label class="font-semibold">Metode Pembayaran:</label>
        <label class="inline-flex items-center cursor-pointer">
          <input
            type="radio"
            name="payment_method"
            value="midtrans"
            checked
            class="form-radio text-blue-600"
          />
          <span class="ml-1">QRIS/VA/e-Wallet</span>
        </label>
        <label class="inline-flex items-center cursor-pointer ml-4">
          <input
            type="radio"
            name="payment_method"
            value="cash"
            class="form-radio text-blue-600"
          />
          <span class="ml-1">Cash</span>
        </label>
      </div>
      <div class="font-bold text-xl text-green-600">
        Total: <span id="checkoutTotal">Rp0</span>
      </div>
    </div>
    <button
      type="submit"
      class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold text-lg"
    >
      Konfirmasi Pesanan
    </button>
  </form>
</div>
<script>
  // Ambil cart dari localStorage/sessionStorage (atau window.cart jika SPA)
  let cart = JSON.parse(localStorage.getItem("customer_cart") || "[]");
  function renderCheckoutCart() {
    const el = document.getElementById("checkoutCartItems");
    if (!cart.length) {
      el.innerHTML =
        '<div class="text-center text-gray-500">Keranjang kosong.</div>';
      document.getElementById("checkoutTotal").innerText = "Rp0";
      return;
    }
    let total = 0;
    el.innerHTML = `<div class="grid grid-cols-1 gap-3">
    ${cart
      .map((item) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        return `
      <div class=\"flex items-center justify-between bg-white rounded shadow p-3\">
        <div class=\"flex items-center gap-3\">
          <img src=\"${
            item.image
          }\" class=\"w-14 h-14 object-cover rounded\" alt=\"${item.name}\" />
          <div>
            <div class=\"font-semibold text-gray-800\">${item.name}</div>
            <div class=\"text-xs text-gray-500\">Rp${item.price.toLocaleString()} x ${
          item.qty
        }</div>
          </div>
        </div>
        <div class=\"font-bold text-lg text-green-700\">Rp${subtotal.toLocaleString()}</div>
      </div>
      `;
      })
      .join("")}
  </div>`;
    document.getElementById("checkoutTotal").innerText =
      "Rp" + total.toLocaleString();
  }
  renderCheckoutCart();

  document.getElementById("customerCheckoutForm").onsubmit = function (e) {
    e.preventDefault();
    if (!cart.length) {
      alert("Keranjang kosong!");
      return;
    }
    const meja = document.getElementById("mejaSelect").value;
    const takeaway = meja === "takeaway";
    if (!meja) {
      alert("Pilih meja atau takeaway!");
      return;
    }
    const payment_method = document.querySelector(
      'input[name="payment_method"]:checked'
    ).value;
    fetch("/customer/order/checkout/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        cart,
        meja_number: meja,
        takeaway,
        payment_method,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          if (payment_method === "cash") {
            localStorage.removeItem("customer_cart");
            window.location.href = `/customer/order-success/${data.order_id}/`;
          } else if (data.snap_token) {
            window.snap.pay(data.snap_token, {
              onSuccess: function (result) {
                localStorage.removeItem("customer_cart");
                window.location.href = `/customer/order-success/${data.order_id}/`;
              },
              onPending: function (result) {
                localStorage.removeItem("customer_cart");
                window.location.href = `/customer/order-success/${data.order_id}/`;
              },
              onError: function (result) {
                alert("Pembayaran gagal. Silakan coba lagi.");
              },
              onClose: function () {},
            });
          }
        } else {
          alert(data.error || "Gagal checkout");
        }
      })
      .catch(() => {
        alert("Gagal terhubung ke server.");
      });
  };
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
<script
  src="https://app.sandbox.midtrans.com/snap/snap.js"
  data-client-key="SB-Mid-client-WqozVbKxVoU3v-9L"
></script>
{% endblock %}
