{% extends "base_customer.html" %} {% block content %}
<div class="container mx-auto p-5 font-poppins">
  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-8">
    <h2 class="text-2xl font-bold mb-4 text-center text-primary">
      Checkout Pesanan Anda
    </h2>
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-4 mt-4 text-secondary">
        Order Details
      </h3>
      <form id="customerCheckoutForm">
        <div id="checkoutCartItems" class="mb-6"></div>
        <div class="mb-4">
          <label class="block mb-1 font-semibold text-primary"
            >Pilih Meja</label
          >
          <select
            id="mejaSelect"
            name="meja_number"
            class="w-full border border-primary rounded px-3 py-2 mb-2 focus:border-accent focus:ring-2 focus:ring-accent/30 transition"
          >
            <option value="">-- Pilih Meja --</option>
            {% for table in tables %}
            <option value="{{ table.table_number }}">
              Meja {{ table.table_number }}
            </option>
            {% endfor %}
            <option value="takeaway">Takeaway</option>
          </select>
        </div>
        <div class="flex justify-between items-center mt-4 border-t pt-4 mb-6">
          <span class="font-semibold text-primary">Total:</span>
          <span id="checkoutTotal" class="font-bold text-xl text-accent"
            >Rp.0</span
          >
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2 text-primary">
            Pilih Metode Pembayaran
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button
              type="button"
              data-method="cash"
              class="payment-method-card border-2 border-secondary rounded-lg p-4 flex flex-col items-center hover:border-primary focus:border-accent transition bg-secondary/10 text-primary font-semibold"
              onclick="selectPaymentMethod('cash', this)"
            >
              <span class="font-medium">Cash</span>
            </button>
            <button
              type="button"
              data-method="midtrans"
              class="payment-method-card border-2 border-accent rounded-lg p-4 flex flex-col items-center hover:border-primary focus:border-accent transition bg-accent/10 text-accent font-semibold"
              onclick="selectPaymentMethod('midtrans', this)"
            >
              <span class="font-medium">MidTrans</span>
            </button>
          </div>
          <input
            type="hidden"
            name="payment_method"
            id="paymentMethodInput"
            value="cash"
          />
        </div>
        <button
          type="submit"
          class="w-full btn-primary py-3 rounded-lg font-bold text-lg shadow-md transition"
        >
          Konfirmasi Pesanan
        </button>
      </form>
    </div>
    <script>
      // Ambil cart dari localStorage/sessionStorage (atau window.cart jika SPA)
      let cart = JSON.parse(localStorage.getItem("customer_cart") || "[]");
      function renderCheckoutCart() {
        const el = document.getElementById("checkoutCartItems");
        if (!cart.length) {
          el.innerHTML =
            '<div class="text-center text-gray-500">Keranjang kosong.</div>';
          document.getElementById("checkoutTotal").innerText = "Rp0";
          return;
        }
        let total = 0;
        el.innerHTML = `<div class="grid grid-cols-1 gap-3">
    ${cart
      .map((item) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        return `
      <div class=\"flex items-center justify-between bg-bg rounded shadow p-3 border border-primary/10\">
        <div class=\"flex items-center gap-3\">
          <img src=\"${
            item.image
          }\" class=\"w-14 h-14 object-cover rounded border border-secondary/30\" alt=\"${
          item.name
        }\" />
          <div>
            <div class=\"font-semibold text-primary\">${item.name}</div>
            <div class=\"text-xs text-secondary\">Rp${item.price.toLocaleString()} x ${
          item.qty
        }</div>
          </div>
        </div>
        <div class=\"font-bold text-lg text-accent\">Rp${subtotal.toLocaleString()}</div>
      </div>
      `;
      })
      .join("")}
  </div>`;
        document.getElementById("checkoutTotal").innerText =
          "Rp" + total.toLocaleString();
      }
      renderCheckoutCart();

      // Payment method button logic
      function selectPaymentMethod(method, btn) {
        document.getElementById("paymentMethodInput").value = method;
        document.querySelectorAll(".payment-method-card").forEach((el) => {
          el.classList.remove("ring-2", "ring-accent");
        });
        btn.classList.add("ring-2", "ring-accent");
      }
      // Set default selected
      window.addEventListener("DOMContentLoaded", () => {
        selectPaymentMethod(
          "cash",
          document.querySelector('.payment-method-card[data-method="cash"]')
        );
      });

      document.getElementById("customerCheckoutForm").onsubmit = function (e) {
        e.preventDefault();
        if (!cart.length) {
          alert("Keranjang kosong!");
          return;
        }
        const meja = document.getElementById("mejaSelect").value;
        const takeaway = meja === "takeaway";
        if (!meja) {
          alert("Pilih meja atau takeaway!");
          return;
        }
        const payment_method =
          document.getElementById("paymentMethodInput").value;
        fetch("/customer/order/checkout/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            cart,
            meja_number: meja,
            takeaway,
            payment_method,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              if (payment_method === "cash") {
                localStorage.removeItem("customer_cart");
                window.location.href = `/customer/order-success/${data.order_id}/`;
              } else if (data.snap_token) {
                window.snap.pay(data.snap_token, {
                  onSuccess: function (result) {
                    localStorage.removeItem("customer_cart");
                    window.location.href = `/customer/order-success/${data.order_id}/`;
                  },
                  onPending: function (result) {
                    localStorage.removeItem("customer_cart");
                    window.location.href = `/customer/order-success/${data.order_id}/`;
                  },
                  onError: function (result) {
                    alert("Pembayaran gagal. Silakan coba lagi.");
                  },
                  onClose: function () {},
                });
              }
            } else {
              alert(data.error || "Gagal checkout");
            }
          })
          .catch(() => {
            alert("Gagal terhubung ke server.");
          });
      };
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
    <script
      src="https://app.sandbox.midtrans.com/snap/snap.js"
      data-client-key="SB-Mid-client-WqozVbKxVoU3v-9L"
    ></script>
    {% endblock %}
  </div>
</div>
